# Harold Action E2E Tests

Этот каталог содержит End-to-End (E2E) тесты для Harold Action, которые проверяют полную функциональность в реальных сценариях GitHub Actions.

## Структура тестов

### GitHub Actions Workflows

- **`test-action.yml`** - Основные E2E тесты
  - Базовая функциональность
  - Различные типы проектов (React, Vue, Angular, etc.)
  - Симуляция fork репозиториев
  - Обработка ошибок
  - Тестирование производительности
  - Пороговые значения

- **`test-environments.yml`** - Тестирование в различных окружениях
  - Кроссплатформенность (Ubuntu, Windows, macOS)
  - Различные версии Node.js
  - Совместимость с версиями Harold
  - Ограничения ресурсов
  - Безопасность
  - CI/CD совместимость

### Тестовый проект

Каталог `test-project/` содержит минимальный проект для тестирования:

- `package.json` - Конфигурация проекта с различными скриптами сборки
- `.haroldrc.js` - Конфигурация Harold для тестов
- `src/` - Исходные файлы для тестирования изменений размера

## Запуск E2E тестов

### Автоматический запуск

E2E тесты запускаются автоматически при:

- Push в ветки `main` или `develop`
- Создании Pull Request'а
- Изменении файлов Action'а (`action.yml`, `scripts/**`, `utils/**`)

### Ручной запуск

Вы можете запустить тесты вручную через GitHub Actions:

1. Перейдите в раздел "Actions" в репозитории
2. Выберите workflow "Test Harold Action E2E"
3. Нажмите "Run workflow"
4. Выберите сценарий тестирования (по умолчанию - все)

### Локальное тестирование

Для локального тестирования отдельных компонентов:

```bash
# Перейдите в каталог тестового проекта
cd tests/e2e/test-project

# Установите зависимости
npm install

# Запустите сборку
npm run build

# Проверьте результат
ls -la dist/
```

## Сценарии тестирования

### 1. Базовая функциональность

- ✅ Создание снимков Harold
- ✅ Сравнение изменений
- ✅ Создание комментариев в PR
- ✅ Обновление существующих комментариев

### 2. Типы проектов

- ✅ React (Create React App)
- ✅ Vue.js (Vue CLI, Vite)
- ✅ Angular (Angular CLI)
- ✅ Next.js
- ✅ Vanilla JavaScript (Webpack, Rollup)
- ✅ Монорепозитории
- ✅ Библиотеки (UMD, ESM, CJS)

### 3. Fork репозитории

- ✅ Ограниченные права доступа
- ✅ Fallback режим (вывод в логи)
- ✅ Graceful handling 403 ошибок
- ✅ Безопасная обработка команд сборки

### 4. Обработка ошибок

- ✅ Harold не установлен
- ✅ Неверная конфигурация
- ✅ Ошибки сборки проекта
- ✅ Недоступность GitHub API
- ✅ Корруптированные файлы

### 5. Производительность

- ✅ Большие проекты (1000+ файлов)
- ✅ Глубокая вложенность директорий
- ✅ Ограничения памяти
- ✅ Таймауты выполнения

### 6. Пороговые значения

- ✅ Превышение размера (байты)
- ✅ Превышение процента изменений
- ✅ Режим fail-on-increase
- ✅ Различные конфигурации порогов

### 7. Безопасность

- ✅ Валидация входных параметров
- ✅ Защита от path traversal
- ✅ Ограничения размера конфигурации
- ✅ Безопасные команды сборки в fork'ах

## Интерпретация результатов

### Успешное выполнение

```
✅ All E2E tests passed successfully!
```

Все тесты прошли успешно, Action готов к использованию.

### Частичные ошибки

```
⚠️ Some E2E tests failed. Please check the logs above.
```

Некоторые тесты не прошли. Проверьте логи для определения проблем:

- **Basic Functionality FAILED** - Критическая ошибка, требует исправления
- **Project Types FAILED** - Проблемы совместимости с определенными типами проектов
- **Fork Simulation FAILED** - Проблемы безопасности или обработки fork'ов
- **Error Handling FAILED** - Неправильная обработка ошибочных ситуаций
- **Performance FAILED** - Проблемы производительности или таймауты
- **Thresholds FAILED** - Неправильная работа пороговых значений

### Анализ логов

В случае ошибок проверьте:

1. **Логи GitHub Actions** - детальная информация о каждом шаге
2. **Harold output** - вывод команды harold diff
3. **Exit codes** - коды завершения для диагностики
4. **Environment variables** - переменные окружения для отладки

## Добавление новых тестов

### Новый тип проекта

1. Добавьте новую матрицу в `test-project-types` job
2. Определите команды setup и конфигурацию Harold
3. Укажите ожидаемые результаты

### Новый сценарий ошибки

1. Добавьте новую матрицу в `test-error-handling` job
2. Создайте условия для воспроизведения ошибки
3. Определите ожидаемое поведение

### Новый тест безопасности

1. Добавьте сценарий в `test-security` job
2. Создайте потенциально небезопасные условия
3. Проверьте правильность защитных механизмов

## Отладка

### Локальная отладка

```bash
# Включите отладочный режим
export DEBUG_TESTS=true

# Запустите конкретный тест
npm test -- --testNamePattern="specific test name"
```

### GitHub Actions отладка

1. Добавьте `continue-on-error: true` к проблемному шагу
2. Используйте `echo` команды для вывода отладочной информации
3. Проверьте переменные окружения через `env`

## Мониторинг

E2E тесты также запускаются по расписанию (ежедневно в 2:00 UTC) для:

- Проверки совместимости с новыми версиями зависимостей
- Мониторинга производительности
- Раннего обнаружения проблем

Результаты доступны в разделе "Actions" репозитория.

## Вклад в развитие

При добавлении новой функциональности в Harold Action:

1. Добавьте соответствующие E2E тесты
2. Убедитесь, что все существующие тесты проходят
3. Обновите документацию при необходимости
4. Проверьте совместимость с различными окружениями

Для вопросов и предложений создавайте issues в репозитории.
