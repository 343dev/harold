name: Dependency Updates

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: false
        default: 'minor'
        type: choice
        options:
          - 'patch'
          - 'minor'
          - 'major'
          - 'all'

env:
  NODE_VERSION: '18'

jobs:
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹
  check-updates:
    name: Check Available Updates
    runs-on: ubuntu-latest

    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
      update-summary: ${{ steps.check.outputs.summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'harold-action/tests/package-lock.json'

      - name: Install dependencies
        run: |
          cd harold-action/tests
          npm ci

      - name: Check for outdated packages
        id: check
        run: |
          cd harold-action/tests

          echo "Checking for outdated packages..."

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
          if npm outdated --json > outdated.json 2>/dev/null; then
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "summary=All packages are up to date" >> $GITHUB_OUTPUT
          else
            # npm outdated Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÐºÐ¾Ð´ 1 ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
            if [ -s outdated.json ]; then
              echo "has-updates=true" >> $GITHUB_OUTPUT

              # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ ÑÐ²Ð¾Ð´ÐºÑƒ
              summary=$(jq -r 'keys | join(", ")' outdated.json 2>/dev/null || echo "Multiple packages")
              echo "summary=Updates available for: $summary" >> $GITHUB_OUTPUT

              echo "ðŸ“¦ Outdated packages found:"
              cat outdated.json | jq '.'
            else
              echo "has-updates=false" >> $GITHUB_OUTPUT
              echo "summary=All packages are up to date" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Check GitHub Actions versions
        run: |
          echo "Checking GitHub Actions versions..."

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸Ð¸ actions Ð² workflow Ñ„Ð°Ð¹Ð»Ð°Ñ…
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
            echo "Checking $file..."

            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ actions
            grep -E "uses: [^@]+@" "$file" | sed 's/.*uses: //' | sort -u | while read -r action; do
              echo "  - $action"
            done
          done

  # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has-updates == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'harold-action/tests/package-lock.json'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          cd harold-action/tests
          npm ci

      - name: Update dependencies
        run: |
          cd harold-action/tests

          UPDATE_TYPE="${{ github.event.inputs.update_type || 'minor' }}"

          echo "Performing $UPDATE_TYPE updates..."

          case "$UPDATE_TYPE" in
            "patch")
              # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ patch Ð²ÐµÑ€ÑÐ¸Ð¸
              npm update --save
              ;;
            "minor")
              # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ minor Ð¸ patch Ð²ÐµÑ€ÑÐ¸Ð¸
              npx npm-check-updates -u --target minor
              npm install
              ;;
            "major")
              # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ major Ð²ÐµÑ€ÑÐ¸Ð¸
              npx npm-check-updates -u --target major
              npm install
              ;;
            "all")
              # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð´Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹
              npx npm-check-updates -u
              npm install
              ;;
          esac

      - name: Run tests after update
        run: |
          cd harold-action/tests

          echo "Running tests to verify updates..."

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹
          if npm test; then
            echo "âœ… All tests passed after dependency updates"
          else
            echo "âŒ Tests failed after dependency updates"
            exit 1
          fi

      - name: Check for security vulnerabilities
        run: |
          cd harold-action/tests

          echo "Checking for security vulnerabilities..."

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸
          if npm audit --audit-level moderate; then
            echo "âœ… No security vulnerabilities found"
          else
            echo "âš ï¸ Security vulnerabilities detected"

            # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ
            npm audit fix --force || true

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑ‰Ðµ Ñ€Ð°Ð·
            if npm audit --audit-level moderate; then
              echo "âœ… Security vulnerabilities fixed"
            else
              echo "âŒ Some security vulnerabilities remain"
              npm audit
            fi
          fi

      - name: Generate update summary
        id: summary
        run: |
          cd harold-action/tests

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ²Ð¾Ð´ÐºÑƒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
          cat > update-summary.md << 'EOF'
          # Dependency Update Summary

          ## Updated Packages

          EOF

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐºÐ°ÐºÐ¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ
          if git diff --name-only | grep -q package.json; then
            echo "The following packages were updated:" >> update-summary.md
            echo "" >> update-summary.md

            # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² package.json
            git diff package.json | grep -E "^\+.*\".*\":" | sed 's/^+//' >> update-summary.md || true

            echo "" >> update-summary.md
          fi

          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚ÐµÑÑ‚Ð°Ñ…
          echo "## Test Results" >> update-summary.md
          echo "" >> update-summary.md
          echo "âœ… All tests passed after dependency updates" >> update-summary.md
          echo "" >> update-summary.md

          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
          echo "## Security Audit" >> update-summary.md
          echo "" >> update-summary.md

          if npm audit --audit-level moderate >/dev/null 2>&1; then
            echo "âœ… No security vulnerabilities detected" >> update-summary.md
          else
            echo "âš ï¸ Some security issues may remain - please review manually" >> update-summary.md
          fi

          echo "summary-file=update-summary.md" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update dependencies

            - Updated npm packages to latest compatible versions
            - All tests passing
            - Security audit completed
          title: 'chore: automated dependency updates'
          body-path: harold-action/tests/update-summary.md
          branch: dependency-updates/automated
          delete-branch: true
          labels: |
            dependencies
            automated
          reviewers: |
            harold-team/maintainers
          draft: false

  # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ GitHub Actions
  update-actions:
    name: Update GitHub Actions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update GitHub Actions versions
        run: |
          echo "Checking for GitHub Actions updates..."

          # Ð¡Ð¿Ð¸ÑÐ¾Ðº actions Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
          declare -A actions_map=(
            ["actions/checkout"]="v4"
            ["actions/setup-node"]="v4"
            ["actions/cache"]="v4"
            ["github/codeql-action/init"]="v3"
            ["github/codeql-action/analyze"]="v3"
            ["actions/github-script"]="v7"
            ["codecov/codecov-action"]="v3"
          )

          updated_actions=""

          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ action
          for action in "${!actions_map[@]}"; do
            latest_version="${actions_map[$action]}"

            echo "Updating $action to $latest_version..."

            # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÑ‚Ð¾Ð³Ð¾ action
            find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
              if grep -q "uses: $action@" "$file"; then
                # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ
                sed -i "s|uses: $action@[^[:space:]]*|uses: $action@$latest_version|g" "$file"
                echo "  Updated in $file"
              fi
            done

            updated_actions="$updated_actions\n- $action@$latest_version"
          done

          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… actions
          echo -e "$updated_actions" > updated-actions.txt

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No GitHub Actions updates needed"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "GitHub Actions updates available"
            git diff --name-only
          fi

      - name: Create Pull Request for Actions
        if: steps.changes.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update GitHub Actions versions

            Updated GitHub Actions to latest stable versions:
            $(cat updated-actions.txt)
          title: 'chore: update GitHub Actions versions'
          body: |
            ## GitHub Actions Updates

            This PR updates GitHub Actions to their latest stable versions:

            $(cat updated-actions.txt)

            ## Changes

            - Updated action versions in workflow files
            - All workflows should continue to work as expected
            - No breaking changes expected

            ## Testing

            Please verify that all workflows still function correctly after merging.
          branch: dependency-updates/github-actions
          delete-branch: true
          labels: |
            dependencies
            github-actions
            automated

  # Ð¡Ð²Ð¾Ð´ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
  update-summary:
    name: Update Summary
    runs-on: ubuntu-latest
    needs: [check-updates, update-dependencies, update-actions]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹
          if [ "${{ needs.check-updates.result }}" = "success" ]; then
            echo "âœ… **Dependency Check:** Completed" >> $GITHUB_STEP_SUMMARY
            echo "   - ${{ needs.check-updates.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Dependency Check:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
          if [ "${{ needs.update-dependencies.result }}" = "success" ]; then
            echo "âœ… **NPM Dependencies:** Updated successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.update-dependencies.result }}" = "skipped" ]; then
            echo "â­ï¸ **NPM Dependencies:** Skipped (no updates needed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **NPM Dependencies:** Update failed" >> $GITHUB_STEP_SUMMARY
          fi

          # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ GitHub Actions
          if [ "${{ needs.update-actions.result }}" = "success" ]; then
            echo "âœ… **GitHub Actions:** Checked and updated if needed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **GitHub Actions:** Update check failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # ÐžÐ±Ñ‰Ð¸Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ
          if [ "${{ needs.check-updates.outputs.has-updates }}" = "true" ]; then
            echo "## ðŸ“¦ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Pull requests have been created for available updates." >> $GITHUB_STEP_SUMMARY
            echo "Please review and merge them after testing." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… All Up to Date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All dependencies are currently up to date." >> $GITHUB_STEP_SUMMARY
          fi
