name: Test Harold Action in Different Environments

on:
  schedule:
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 2:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      os_matrix:
        description: 'Operating systems to test'
        required: false
        default: 'ubuntu-latest,windows-latest,macos-latest'
        type: string
      node_versions:
        description: 'Node.js versions to test'
        required: false
        default: '18,20,22'
        type: string

jobs:
  # ĞœĞ°Ñ‚Ñ€Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ĞĞ¡ Ğ¸ Ğ²ĞµÑ€ÑĞ¸ÑÑ… Node.js
  test-matrix:
    name: Test on ${{ matrix.os }} with Node.js ${{ matrix.node-version }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson(format('["{0}"]', join(split(github.event.inputs.os_matrix || 'ubuntu-latest,windows-latest,macos-latest', ','), '","'))) }}
        node-version: ${{ fromJson(format('["{0}"]', join(split(github.event.inputs.node_versions || '18,20,22', ','), '","'))) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Create cross-platform test project
        shell: bash
        run: |
          mkdir -p test-cross-platform/dist

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ ĞºÑ€Ğ¾ÑÑĞ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸
          echo 'console.log("Cross-platform test");' > test-cross-platform/dist/app.js
          echo 'body { margin: 0; }' > test-cross-platform/dist/style.css

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Harold
          cat > test-cross-platform/.haroldrc.js << 'EOF'
          export default {
            build: {
              command: 'echo "Cross-platform build completed"',
              path: 'dist'
            },
            categories: {
              js: '**/*.js',
              css: '**/*.css'
            }
          };
          EOF

      - name: Test Harold Action
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "Cross-platform build completed"'
          build-path: 'test-cross-platform/dist'
          config-path: 'test-cross-platform/.haroldrc.js'

      - name: Verify cross-platform compatibility
        shell: bash
        run: |
          echo "âœ… Cross-platform test completed on ${{ matrix.os }} with Node.js ${{ matrix.node-version }}"

          if [ -f "harold-output.txt" ]; then
            echo "Harold output:"
            cat harold-output.txt
          else
            echo "âŒ Harold output file not found"
            exit 1
          fi

  # Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¼Ğ¸ Ğ²ĞµÑ€ÑĞ¸ÑĞ¼Ğ¸ Harold
  test-harold-versions:
    name: Test with Harold Versions
    runs-on: ubuntu-latest

    strategy:
      matrix:
        harold-version:
          - 'latest'
          - '1.0.0'  # Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install specific Harold version
        run: |
          if [ "${{ matrix.harold-version }}" = "latest" ]; then
            npm install -g @343dev/harold@latest
          else
            npm install -g @343dev/harold@${{ matrix.harold-version }}
          fi

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
          harold --version || echo "Harold version check failed"

      - name: Create test project
        run: |
          mkdir -p test-harold-version/dist
          echo 'console.log("Harold version test");' > test-harold-version/dist/app.js

          cat > test-harold-version/.haroldrc.js << 'EOF'
          export default {
            build: { command: 'echo "Build completed"', path: 'dist' },
            categories: { js: '**/*.js' }
          };
          EOF

      - name: Test with Harold ${{ matrix.harold-version }}
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "Build completed"'
          build-path: 'test-harold-version/dist'
          config-path: 'test-harold-version/.haroldrc.js'

      - name: Verify Harold version compatibility
        run: |
          echo "âœ… Harold ${{ matrix.harold-version }} compatibility test completed"

  # Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
  test-resource-limits:
    name: Test Resource Limits
    runs-on: ubuntu-latest

    strategy:
      matrix:
        scenario:
          - name: 'memory-limit'
            description: 'Test with limited memory'
            node-options: '--max-old-space-size=512'

          - name: 'large-project'
            description: 'Test with very large project'
            file-count: 1000

          - name: 'deep-nesting'
            description: 'Test with deeply nested directories'
            depth: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup test scenario - ${{ matrix.scenario.name }}
        run: |
          mkdir -p test-resources/dist

          if [ "${{ matrix.scenario.name }}" = "large-project" ]; then
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
            for i in $(seq 1 ${{ matrix.scenario.file-count || 100 }}); do
              echo "console.log('File $i');" > test-resources/dist/file-$i.js
            done
          elif [ "${{ matrix.scenario.name }}" = "deep-nesting" ]; then
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ³Ğ»ÑƒĞ±Ğ¾ĞºÑƒÑ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ
            current_dir="test-resources/dist"
            for i in $(seq 1 ${{ matrix.scenario.depth || 5 }}); do
              current_dir="$current_dir/level-$i"
              mkdir -p "$current_dir"
              echo "console.log('Level $i');" > "$current_dir/file.js"
            done
          else
            # ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
            echo 'console.log("Resource test");' > test-resources/dist/app.js
          fi

          cat > test-resources/.haroldrc.js << 'EOF'
          export default {
            build: { command: 'echo "Build completed"', path: 'dist' },
            categories: { js: '**/*.js' }
          };
          EOF

      - name: Set Node.js options
        if: matrix.scenario.node-options
        run: echo "NODE_OPTIONS=${{ matrix.scenario.node-options }}" >> $GITHUB_ENV

      - name: Test Harold Action with resource constraints
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "Build completed"'
          build-path: 'test-resources/dist'
          config-path: 'test-resources/.haroldrc.js'
        timeout-minutes: 10

      - name: Verify resource handling
        run: |
          echo "âœ… Resource limit test (${{ matrix.scenario.name }}) completed"

          if [ -f "harold-output.txt" ]; then
            echo "Harold handled ${{ matrix.scenario.description }} successfully"
            wc -l harold-output.txt
          fi

  # Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
  test-security:
    name: Test Security Features
    runs-on: ubuntu-latest

    strategy:
      matrix:
        security-scenario:
          - name: 'malicious-config'
            description: 'Test with potentially malicious config'
            config: |
              export default {
                build: {
                  command: 'echo "Safe command"',
                  path: 'dist'
                },
                // ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´
                malicious: (() => {
                  try {
                    require('child_process').exec('echo "This should not execute"');
                  } catch(e) {}
                })()
              };

          - name: 'large-config'
            description: 'Test with oversized config file'
            config-size: 15000  # Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ° Ğ² 10KB

          - name: 'path-traversal'
            description: 'Test path traversal protection'
            build-path: '../../../etc'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup security test - ${{ matrix.security-scenario.name }}
        run: |
          mkdir -p test-security/dist
          echo 'console.log("Security test");' > test-security/dist/app.js

          if [ "${{ matrix.security-scenario.name }}" = "large-config" ]; then
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
            echo "export default {" > test-security/.haroldrc.js
            echo "  build: { command: 'echo \"Build completed\"', path: 'dist' }," >> test-security/.haroldrc.js
            echo "  categories: { js: '**/*.js' }," >> test-security/.haroldrc.js
            echo "  largeData: '" >> test-security/.haroldrc.js
            yes "A" | head -n ${{ matrix.security-scenario.config-size || 1000 }} | tr -d '\n' >> test-security/.haroldrc.js
            echo "'" >> test-security/.haroldrc.js
            echo "};" >> test-security/.haroldrc.js
          elif [ "${{ matrix.security-scenario.name }}" = "malicious-config" ]; then
            cat > test-security/.haroldrc.js << 'EOF'
          ${{ matrix.security-scenario.config }}
          EOF
          else
            cat > test-security/.haroldrc.js << 'EOF'
          export default {
            build: { command: 'echo "Build completed"', path: 'dist' },
            categories: { js: '**/*.js' }
          };
          EOF
          fi

      - name: Simulate fork environment for security test
        if: matrix.security-scenario.name != 'path-traversal'
        run: |
          echo "IS_FORK=true" >> $GITHUB_ENV
          echo "HAS_WRITE_ACCESS=false" >> $GITHUB_ENV

      - name: Test Harold Action security
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "Build completed"'
          build-path: ${{ matrix.security-scenario.build-path || 'test-security/dist' }}
          config-path: 'test-security/.haroldrc.js'
        continue-on-error: true
        id: security-test

      - name: Verify security handling
        run: |
          echo "âœ… Security test (${{ matrix.security-scenario.name }}) completed"

          # Ğ”Ğ»Ñ Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ
          if [ "${{ matrix.security-scenario.name }}" = "path-traversal" ]; then
            if [ "${{ steps.security-test.outcome }}" = "failure" ]; then
              echo "âœ… Path traversal correctly blocked"
            else
              echo "âš ï¸  Path traversal should have been blocked"
            fi
          fi

  # Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¼Ğ¸ CI/CD ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°Ğ¼Ğ¸
  test-ci-compatibility:
    name: Test CI/CD Compatibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Simulate different CI environments
        run: |
          # Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ CI ÑĞ¸ÑÑ‚ĞµĞ¼

          echo "Testing GitHub Actions environment..."
          export CI=true
          export GITHUB_ACTIONS=true

          mkdir -p test-ci/dist
          echo 'console.log("CI test");' > test-ci/dist/app.js

          cat > test-ci/.haroldrc.js << 'EOF'
          export default {
            build: { command: 'echo "CI build completed"', path: 'dist' },
            categories: { js: '**/*.js' }
          };
          EOF

      - name: Test Harold Action in CI environment
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "CI build completed"'
          build-path: 'test-ci/dist'
          config-path: 'test-ci/.haroldrc.js'

      - name: Verify CI compatibility
        run: |
          echo "âœ… CI/CD compatibility test completed"

  # Ğ¡Ğ²Ğ¾Ğ´ĞºĞ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¹
  environment-test-summary:
    name: Environment Test Summary
    runs-on: ubuntu-latest
    needs: [test-matrix, test-harold-versions, test-resource-limits, test-security, test-ci-compatibility]
    if: always()

    steps:
      - name: Generate environment test summary
        run: |
          echo "# Harold Action Environment Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Environment Compatibility Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-matrix.result }}" = "success" ]; then
            echo "âœ… **Cross-Platform Matrix:** All OS and Node.js versions passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Cross-Platform Matrix:** Some combinations failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-harold-versions.result }}" = "success" ]; then
            echo "âœ… **Harold Versions:** All tested versions compatible" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Harold Versions:** Some version compatibility issues" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-resource-limits.result }}" = "success" ]; then
            echo "âœ… **Resource Limits:** Handled all resource constraints" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Resource Limits:** Some resource handling issues" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-security.result }}" = "success" ]; then
            echo "âœ… **Security:** All security tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Security:** Some security concerns detected" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-ci-compatibility.result }}" = "success" ]; then
            echo "âœ… **CI/CD Compatibility:** Compatible with CI environments" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **CI/CD Compatibility:** Some CI compatibility issues" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # ĞĞ±Ñ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          failed_count=0

          [ "${{ needs.test-matrix.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.test-harold-versions.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.test-resource-limits.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.test-security.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.test-ci-compatibility.result }}" != "success" ] && ((failed_count++))

          if [ $failed_count -eq 0 ]; then
            echo "## ğŸ‰ Overall Status: ALL TESTS PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Harold Action is compatible with all tested environments and scenarios." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Overall Status: $failed_count TEST(S) FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed tests and address any compatibility issues." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set final exit code
        run: |
          failed_count=0

          [ "${{ needs.test-matrix.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.test-harold-versions.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.test-resource-limits.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.test-security.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.test-ci-compatibility.result }}" != "success" ] && ((failed_count++))

          if [ $failed_count -gt 0 ]; then
            echo "âŒ Environment tests failed: $failed_count test(s)"
            exit 1
          else
            echo "âœ… All environment tests passed"
          fi
