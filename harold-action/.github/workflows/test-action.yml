name: Test Harold Action E2E

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'action.yml'
      - 'scripts/**'
      - 'utils/**'
      - '.github/workflows/test-action.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'action.yml'
      - 'scripts/**'
      - 'utils/**'
      - '.github/workflows/test-action.yml'
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'basic'
          - 'fork-simulation'
          - 'error-handling'
          - 'performance'

env:
  NODE_VERSION: '18'

jobs:
  # –ë–∞–∑–æ–≤—ã–µ E2E —Ç–µ—Å—Ç—ã
  test-basic-functionality:
    name: Test Basic Functionality
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.test_scenario == 'all' || github.event.inputs.test_scenario == 'basic'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Create test project structure
        run: |
          mkdir -p test-project/src test-project/dist

          # –°–æ–∑–¥–∞–µ–º package.json
          cat > test-project/package.json << 'EOF'
          {
            "name": "test-project",
            "version": "1.0.0",
            "scripts": {
              "build": "mkdir -p dist && echo 'console.log(\"Hello World\");' > dist/app.js && echo 'body { color: red; }' > dist/style.css"
            }
          }
          EOF

          # –°–æ–∑–¥–∞–µ–º harold –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          cat > test-project/.haroldrc.js << 'EOF'
          export default {
            build: {
              command: 'npm run build',
              path: 'dist'
            },
            categories: {
              js: '**/*.js',
              css: '**/*.css'
            }
          };
          EOF

      - name: Test Harold Action with no changes
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'cd test-project && npm run build'
          build-path: 'test-project/dist'
          config-path: 'test-project/.haroldrc.js'
          working-directory: '.'
        continue-on-error: true

      - name: Verify action completed
        run: |
          echo "‚úÖ Basic functionality test completed"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã Harold –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã
          if [ -f "harold-output.txt" ]; then
            echo "‚úÖ Harold output file created"
            cat harold-output.txt
          else
            echo "‚ùå Harold output file not found"
            exit 1
          fi

          if [ -f "harold-exit-code.txt" ]; then
            echo "‚úÖ Harold exit code file created"
            cat harold-exit-code.txt
          else
            echo "‚ùå Harold exit code file not found"
            exit 1
          fi

  # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤
  test-project-types:
    name: Test Different Project Types
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.test_scenario == 'all'

    strategy:
      matrix:
        project-type:
          - name: 'react'
            setup: |
              npx create-react-app test-react-app --template typescript
              cd test-react-app
              npm run build
            build-path: 'test-react-app/build'
            config: |
              export default {
                build: { command: 'npm run build', path: 'build' },
                categories: {
                  js: 'static/js/**/*.js',
                  css: 'static/css/**/*.css',
                  media: 'static/media/**/*'
                }
              };

          - name: 'vue'
            setup: |
              npm create vue@latest test-vue-app -- --typescript --router --pinia
              cd test-vue-app
              npm install
              npm run build
            build-path: 'test-vue-app/dist'
            config: |
              export default {
                build: { command: 'npm run build', path: 'dist' },
                categories: {
                  js: 'assets/**/*.js',
                  css: 'assets/**/*.css'
                }
              };

          - name: 'vanilla'
            setup: |
              mkdir -p test-vanilla-app/src test-vanilla-app/dist
              echo 'console.log("Vanilla JS App");' > test-vanilla-app/src/app.js
              echo 'body { font-family: Arial; }' > test-vanilla-app/src/style.css
              cd test-vanilla-app
              cp src/* dist/
            build-path: 'test-vanilla-app/dist'
            config: |
              export default {
                build: { command: 'cp src/* dist/', path: 'dist' },
                categories: {
                  js: '**/*.js',
                  css: '**/*.css'
                }
              };

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup project - ${{ matrix.project-type.name }}
        run: ${{ matrix.project-type.setup }}
        timeout-minutes: 10

      - name: Create Harold config
        run: |
          cat > .haroldrc.js << 'EOF'
          ${{ matrix.project-type.config }}
          EOF

      - name: Test Harold Action
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "Build already completed in setup"'
          build-path: ${{ matrix.project-type.build-path }}
          config-path: '.haroldrc.js'
        continue-on-error: true

      - name: Verify results
        run: |
          echo "‚úÖ ${{ matrix.project-type.name }} project test completed"

          if [ -f "harold-output.txt" ]; then
            echo "Harold output for ${{ matrix.project-type.name }}:"
            cat harold-output.txt
          fi

  # –°–∏–º—É–ª—è—Ü–∏—è fork —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
  test-fork-simulation:
    name: Test Fork Repository Simulation
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.test_scenario == 'all' || github.event.inputs.test_scenario == 'fork-simulation'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create test project
        run: |
          mkdir -p test-fork-project/dist
          echo 'console.log("Fork test");' > test-fork-project/dist/app.js

          cat > test-fork-project/.haroldrc.js << 'EOF'
          export default {
            build: { command: 'echo "No build needed"', path: 'dist' },
            categories: { js: '**/*.js' }
          };
          EOF

      - name: Simulate fork environment
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–∞–∫ –≤ fork'–µ
          echo "IS_FORK=true" >> $GITHUB_ENV
          echo "HAS_WRITE_ACCESS=false" >> $GITHUB_ENV
          echo "CAN_COMMENT=false" >> $GITHUB_ENV
          echo "ACCESS_LEVEL=limited" >> $GITHUB_ENV

      - name: Test Harold Action in fork mode
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "No build needed"'
          build-path: 'test-fork-project/dist'
          config-path: 'test-fork-project/.haroldrc.js'
        continue-on-error: true

      - name: Verify fork behavior
        run: |
          echo "‚úÖ Fork simulation test completed"

          # –í fork —Ä–µ–∂–∏–º–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –ª–æ–≥–∞—Ö, –∞ –Ω–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
          if [ -f "harold-output.txt" ]; then
            echo "Harold output in fork mode:"
            cat harold-output.txt
          fi

  # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
  test-error-handling:
    name: Test Error Handling
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.test_scenario == 'all' || github.event.inputs.test_scenario == 'error-handling'

    strategy:
      matrix:
        error-scenario:
          - name: 'missing-build-directory'
            setup: |
              mkdir -p test-error-project
              # –ù–µ —Å–æ–∑–¥–∞–µ–º dist –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            build-path: 'test-error-project/nonexistent'
            expected-error: 'Could not find build directory'

          - name: 'invalid-config'
            setup: |
              mkdir -p test-error-project/dist
              echo 'console.log("test");' > test-error-project/dist/app.js
              # –°–æ–∑–¥–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
              echo 'invalid javascript syntax {' > test-error-project/.haroldrc.js
            build-path: 'test-error-project/dist'
            expected-error: 'Invalid harold configuration'

          - name: 'build-command-failure'
            setup: |
              mkdir -p test-error-project
              # –ö–æ–º–∞–Ω–¥–∞ —Å–±–æ—Ä–∫–∏ –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å
            build-command: 'exit 1'
            build-path: 'test-error-project/dist'
            expected-error: 'Build failed'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup error scenario - ${{ matrix.error-scenario.name }}
        run: ${{ matrix.error-scenario.setup }}

      - name: Test Harold Action with error
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: ${{ matrix.error-scenario.build-command || 'echo "Build completed"' }}
          build-path: ${{ matrix.error-scenario.build-path }}
          config-path: 'test-error-project/.haroldrc.js'
        continue-on-error: true

      - name: Verify error handling
        run: |
          echo "‚úÖ Error handling test for ${{ matrix.error-scenario.name }} completed"

          if [ -f "harold-output.txt" ]; then
            echo "Harold output (should contain error):"
            cat harold-output.txt

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—à–∏–±–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
            if grep -q "${{ matrix.error-scenario.expected-error }}" harold-output.txt; then
              echo "‚úÖ Expected error message found"
            else
              echo "‚ö†Ô∏è  Expected error message not found, but this might be expected"
            fi
          fi

  # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  test-performance:
    name: Test Performance
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.test_scenario == 'all' || github.event.inputs.test_scenario == 'performance'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create large test project
        run: |
          mkdir -p test-perf-project/dist

          # –°–æ–∑–¥–∞–µ–º –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
          for i in {1..100}; do
            echo "console.log('Component $i');" > test-perf-project/dist/component-$i.js
            echo ".component-$i { color: blue; }" > test-perf-project/dist/component-$i.css
          done

          # –°–æ–∑–¥–∞–µ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª
          yes "console.log('Large file content');" | head -n 1000 > test-perf-project/dist/large-file.js

          cat > test-perf-project/.haroldrc.js << 'EOF'
          export default {
            build: { command: 'echo "Build completed"', path: 'dist' },
            categories: {
              js: '**/*.js',
              css: '**/*.css'
            }
          };
          EOF

      - name: Test Harold Action performance
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "Build completed"'
          build-path: 'test-perf-project/dist'
          config-path: 'test-perf-project/.haroldrc.js'
        timeout-minutes: 5

      - name: Verify performance
        run: |
          echo "‚úÖ Performance test completed"

          if [ -f "harold-output.txt" ]; then
            echo "Harold output for large project:"
            head -n 20 harold-output.txt
            echo "..."
            echo "Total lines in output: $(wc -l < harold-output.txt)"
          fi

  # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø–æ—Ä–æ–≥–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
  test-thresholds:
    name: Test Threshold Configuration
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.test_scenario == 'all'

    strategy:
      matrix:
        threshold-config:
          - name: 'strict-thresholds'
            size-threshold: '100'
            percentage-threshold: '0.1'
            fail-on-increase: 'true'
            expected-result: 'should-fail'

          - name: 'lenient-thresholds'
            size-threshold: '1048576'  # 1MB
            percentage-threshold: '50'
            fail-on-increase: 'true'
            expected-result: 'should-pass'

          - name: 'no-failure'
            size-threshold: '100'
            percentage-threshold: '0.1'
            fail-on-increase: 'false'
            expected-result: 'should-pass'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create test project with changes
        run: |
          mkdir -p test-threshold-project/dist

          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª—ã —Å –∑–∞–º–µ—Ç–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
          echo 'console.log("Large change");' > test-threshold-project/dist/app.js
          yes "console.log('padding');" | head -n 100 >> test-threshold-project/dist/app.js

          cat > test-threshold-project/.haroldrc.js << 'EOF'
          export default {
            build: { command: 'echo "Build completed"', path: 'dist' },
            categories: { js: '**/*.js' }
          };
          EOF

      - name: Test Harold Action with ${{ matrix.threshold-config.name }}
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "Build completed"'
          build-path: 'test-threshold-project/dist'
          config-path: 'test-threshold-project/.haroldrc.js'
          size-threshold: ${{ matrix.threshold-config.size-threshold }}
          percentage-threshold: ${{ matrix.threshold-config.percentage-threshold }}
          fail-on-increase: ${{ matrix.threshold-config.fail-on-increase }}
        continue-on-error: true
        id: harold-action

      - name: Verify threshold behavior
        run: |
          echo "‚úÖ Threshold test for ${{ matrix.threshold-config.name }} completed"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if [ "${{ matrix.threshold-config.expected-result }}" = "should-fail" ]; then
            if [ "${{ steps.harold-action.outcome }}" = "failure" ]; then
              echo "‚úÖ Action correctly failed due to threshold"
            else
              echo "‚ö†Ô∏è  Action should have failed but didn't"
            fi
          else
            if [ "${{ steps.harold-action.outcome }}" = "success" ]; then
              echo "‚úÖ Action correctly passed"
            else
              echo "‚ö†Ô∏è  Action should have passed but failed"
            fi
          fi

  # –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-basic-functionality, test-project-types, test-fork-simulation, test-error-handling, test-performance, test-thresholds]
    if: always()

    steps:
      - name: Generate test summary
        run: |
          echo "# Harold Action E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–≥–æ job'–∞
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-basic-functionality.result }}" = "success" ]; then
            echo "‚úÖ Basic Functionality: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Basic Functionality: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-project-types.result }}" = "success" ]; then
            echo "‚úÖ Project Types: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Project Types: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-fork-simulation.result }}" = "success" ]; then
            echo "‚úÖ Fork Simulation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Fork Simulation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-error-handling.result }}" = "success" ]; then
            echo "‚úÖ Error Handling: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Error Handling: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-performance.result }}" = "success" ]; then
            echo "‚úÖ Performance: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Performance: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-thresholds.result }}" = "success" ]; then
            echo "‚úÖ Thresholds: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Thresholds: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Status" >> $GITHUB_STEP_SUMMARY

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
          if [ "${{ needs.test-basic-functionality.result }}" = "success" ] && \
             [ "${{ needs.test-project-types.result }}" = "success" ] && \
             [ "${{ needs.test-fork-simulation.result }}" = "success" ] && \
             [ "${{ needs.test-error-handling.result }}" = "success" ] && \
             [ "${{ needs.test-performance.result }}" = "success" ] && \
             [ "${{ needs.test-thresholds.result }}" = "success" ]; then
            echo "üéâ **All E2E tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "üí• **Some E2E tests failed. Please check the logs above.**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set final status
        run: |
          # –ï—Å–ª–∏ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –∑–∞–≤–µ—Ä—à–∞–µ–º —Å –æ—à–∏–±–∫–æ–π
          if [ "${{ needs.test-basic-functionality.result }}" = "failure" ]; then
            echo "‚ùå Critical test failed: Basic Functionality"
            exit 1
          fi

          echo "‚úÖ E2E tests completed"
