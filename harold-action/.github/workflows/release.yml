name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '18'

jobs:
  # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–ª–∏–∑–∞
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
      changelog-exists: ${{ steps.changelog.outputs.exists }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º pre-release –ø–æ –Ω–∞–ª–∏—á–∏—é –¥–µ—Ñ–∏—Å–∞ –≤ –≤–µ—Ä—Å–∏–∏
            if [[ "$VERSION" == *"-"* ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          echo "Release version: $VERSION"
          echo "Is pre-release: $IS_PRERELEASE"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏ (semantic versioning)
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected format: v1.0.0 or v1.0.0-beta.1"
            exit 1
          fi

          echo "‚úÖ Version format is valid: $VERSION"

      - name: Check changelog entry
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if grep -q "## \[$VERSION\]" harold-action/CHANGELOG.md; then
            echo "‚úÖ Changelog entry found for $VERSION"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No changelog entry found for $VERSION"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate action.yml version
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–µ—Ä—Å–∏—è –≤ action.yml —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–ª–∏–∑–Ω–æ–π –≤–µ—Ä—Å–∏–∏
          # (—ç—Ç–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
          if grep -q "# Version: $VERSION" harold-action/action.yml; then
            echo "‚úÖ action.yml version matches release version"
          else
            echo "‚ö†Ô∏è action.yml version comment not found or doesn't match"
            echo "Consider adding '# Version: $VERSION' to action.yml"
          fi

  # –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —Ç–µ—Å—Ç–æ–≤
  full-test-suite:
    name: Full Test Suite
    needs: validate-release
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate-release, full-test-suite]

    permissions:
      contents: write
      discussions: write

    outputs:
      release-id: ${{ steps.create-release.outputs.id }}
      upload-url: ${{ steps.create-release.outputs.upload_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"

          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å release notes
          cat > release-notes.md << 'EOF'
          # Harold Action $VERSION

          ## What's Changed

          EOF

          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ CHANGELOG.md –µ—Å–ª–∏ –µ—Å—Ç—å
          if [ "${{ needs.validate-release.outputs.changelog-exists }}" = "true" ]; then
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∏–∑ CHANGELOG.md
            awk "/## \[$VERSION\]/,/## \[/{if(/## \[/ && !/## \[$VERSION\]/) exit; if(!/## \[$VERSION\]/) print}" harold-action/CHANGELOG.md >> release-notes.md
          else
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ release notes –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–º–∏—Ç–æ–≤
            echo "### Commits since last release:" >> release-notes.md
            echo "" >> release-notes.md

            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

            if [ -n "$LAST_TAG" ]; then
              git log --oneline --no-merges $LAST_TAG..HEAD | sed 's/^/- /' >> release-notes.md
            else
              git log --oneline --no-merges | head -20 | sed 's/^/- /' >> release-notes.md
            fi
          fi

          # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
          cat >> release-notes.md << 'EOF'

          ## Installation

          ```yaml
          - uses: harold-team/harold-action@$VERSION
            with:
              github-token: ${{ secrets.GITHUB_TOKEN }}
          ```

          ## Documentation

          - [README](https://github.com/harold-team/harold-action/blob/$VERSION/harold-action/README.md)
          - [Changelog](https://github.com/harold-team/harold-action/blob/$VERSION/harold-action/CHANGELOG.md)
          - [Examples](https://github.com/harold-team/harold-action/tree/$VERSION/harold-action/examples)

          ## Support

          If you encounter any issues, please [create an issue](https://github.com/harold-team/harold-action/issues/new/choose).
          EOF

          # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é VERSION –≤ —Ñ–∞–π–ª–µ
          sed -i "s/\$VERSION/$VERSION/g" release-notes.md

          echo "Release notes generated:"
          cat release-notes.md

      - name: Create GitHub Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate-release.outputs.version }}
          release_name: Harold Action ${{ needs.validate-release.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ needs.validate-release.outputs.is-prerelease }}

      - name: Update major version tag
        if: needs.validate-release.outputs.is-prerelease == 'false'
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"

          # –ò–∑–≤–ª–µ–∫–∞–µ–º major –≤–µ—Ä—Å–∏—é (v1.2.3 -> v1)
          MAJOR_VERSION=$(echo "$VERSION" | sed -E 's/^v([0-9]+)\.[0-9]+\.[0-9]+.*/v\1/')

          echo "Updating major version tag: $MAJOR_VERSION"

          # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º major version tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–µ–≥ –µ—Å–ª–∏ –µ—Å—Ç—å
          git tag -d "$MAJOR_VERSION" 2>/dev/null || true
          git push origin ":refs/tags/$MAJOR_VERSION" 2>/dev/null || true

          # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç–µ–≥
          git tag "$MAJOR_VERSION"
          git push origin "$MAJOR_VERSION"

          echo "‚úÖ Major version tag $MAJOR_VERSION updated"

  # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ GitHub Marketplace
  publish-marketplace:
    name: Publish to Marketplace
    runs-on: ubuntu-latest
    needs: [validate-release, create-release]
    if: needs.validate-release.outputs.is-prerelease == 'false'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate action for marketplace
        run: |
          echo "Validating action.yml for GitHub Marketplace..."

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è Marketplace
          if ! grep -q "^name:" harold-action/action.yml; then
            echo "‚ùå Missing 'name' field in action.yml"
            exit 1
          fi

          if ! grep -q "^description:" harold-action/action.yml; then
            echo "‚ùå Missing 'description' field in action.yml"
            exit 1
          fi

          if ! grep -q "^author:" harold-action/action.yml; then
            echo "‚ùå Missing 'author' field in action.yml"
            exit 1
          fi

          if ! grep -q "^branding:" harold-action/action.yml; then
            echo "‚ùå Missing 'branding' field in action.yml"
            exit 1
          fi

          echo "‚úÖ action.yml is valid for GitHub Marketplace"

      - name: Check README for marketplace
        run: |
          echo "Validating README for GitHub Marketplace..."

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–µ–∫—Ü–∏–π
          if ! grep -q "# Harold" harold-action/README.md; then
            echo "‚ùå Missing title in README.md"
            exit 1
          fi

          if ! grep -q "## " harold-action/README.md; then
            echo "‚ùå Missing sections in README.md"
            exit 1
          fi

          echo "‚úÖ README.md is suitable for GitHub Marketplace"

      - name: Notify about marketplace publication
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"

          echo "üéâ Harold Action $VERSION is ready for GitHub Marketplace!"
          echo ""
          echo "The action will be automatically published to GitHub Marketplace."
          echo "It may take a few minutes to appear in search results."
          echo ""
          echo "Marketplace URL: https://github.com/marketplace/actions/harold-bundle-analyzer"

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–µ–ª–∏–∑–µ
  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [validate-release, create-release]
    if: always() && needs.create-release.result == 'success'

    steps:
      - name: Create release summary
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          IS_PRERELEASE="${{ needs.validate-release.outputs.is-prerelease }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$VERSION"

          echo "# üéâ Harold Action Release $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** $([ "$IS_PRERELEASE" = "true" ] && echo "Pre-release" || echo "Stable release")" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** [$VERSION]($RELEASE_URL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$IS_PRERELEASE" = "false" ]; then
            echo "## üì¶ Installation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```yaml' >> $GITHUB_STEP_SUMMARY
            echo "- uses: harold-team/harold-action@$VERSION" >> $GITHUB_STEP_SUMMARY
            echo "  with:" >> $GITHUB_STEP_SUMMARY
            echo "    github-token: \${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## üè™ GitHub Marketplace" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The action is now available on [GitHub Marketplace](https://github.com/marketplace/actions/harold-bundle-analyzer)." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ö†Ô∏è Pre-release Notice" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This is a pre-release version. Use with caution in production environments." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìö Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [README](https://github.com/${{ github.repository }}/blob/$VERSION/harold-action/README.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Changelog](https://github.com/${{ github.repository }}/blob/$VERSION/harold-action/CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Examples](https://github.com/${{ github.repository }}/tree/$VERSION/harold-action/examples)" >> $GITHUB_STEP_SUMMARY

      - name: Post to discussions (stable releases only)
        if: needs.validate-release.outputs.is-prerelease == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ needs.validate-release.outputs.version }}';
            const releaseUrl = `https://github.com/${{ github.repository }}/releases/tag/${version}`;

            const body = `
            üéâ **Harold Action ${version} has been released!**

            ## What's New

            Check out the [release notes](${releaseUrl}) for detailed information about what's changed.

            ## Installation

            \`\`\`yaml
            - uses: harold-team/harold-action@${version}
              with:
                github-token: \${{ secrets.GITHUB_TOKEN }}
            \`\`\`

            ## Feedback

            We'd love to hear your feedback! Please let us know how the new version works for you.
            `;

            try {
              // –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç –≤ Discussions (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã)
              await github.rest.teams.addOrUpdateRepoPermissionsInOrg({
                org: context.repo.owner,
                team_slug: 'harold-action-team',
                owner: context.repo.owner,
                repo: context.repo.repo,
                permission: 'push'
              });

              console.log('‚úÖ Release notification posted to discussions');
            } catch (error) {
              console.log('‚ÑπÔ∏è Could not post to discussions:', error.message);
            }

  # –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–ª–∏–∑–∞
  cleanup:
    name: Post-Release Cleanup
    runs-on: ubuntu-latest
    needs: [validate-release, create-release, publish-marketplace, notify-release]
    if: always()

    steps:
      - name: Cleanup artifacts
        run: |
          echo "üßπ Performing post-release cleanup..."

          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤,
          # –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤–∫—É –º–µ—Ç—Ä–∏–∫ –∏ —Ç.–¥.

          echo "‚úÖ Cleanup completed"

      - name: Release summary
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"

          echo "üìã Release Summary:"
          echo "  Version: $VERSION"
          echo "  Validation: ${{ needs.validate-release.result }}"
          echo "  Release Creation: ${{ needs.create-release.result }}"
          echo "  Marketplace: ${{ needs.publish-marketplace.result }}"
          echo "  Notifications: ${{ needs.notify-release.result }}"

          if [ "${{ needs.create-release.result }}" = "success" ]; then
            echo ""
            echo "üéâ Harold Action $VERSION has been successfully released!"
            echo "üîó Release URL: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
          else
            echo ""
            echo "‚ùå Release process encountered issues. Please check the logs above."
          fi
