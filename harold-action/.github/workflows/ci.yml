name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # –õ–∏–Ω—Ç–∏–Ω–≥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'harold-action/tests/package-lock.json'

      - name: Install dependencies
        run: |
          cd harold-action/tests
          npm ci

      - name: Run ESLint
        run: |
          cd harold-action/tests
          npm run lint

      - name: Check shell scripts with shellcheck
        run: |
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ shellcheck
          sudo apt-get update
          sudo apt-get install -y shellcheck

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö bash —Å–∫—Ä–∏–ø—Ç–æ–≤
          find harold-action/scripts -name "*.sh" -type f -exec shellcheck {} \;

      - name: Check YAML files
        run: |
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ yamllint
          pip install yamllint

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ YAML —Ñ–∞–π–ª–æ–≤
          yamllint harold-action/action.yml
          yamllint harold-action/.github/workflows/
          yamllint harold-action/.github/ISSUE_TEMPLATE/

  # Unit —Ç–µ—Å—Ç—ã
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'harold-action/tests/package-lock.json'

      - name: Install dependencies
        run: |
          cd harold-action/tests
          npm ci

      - name: Run unit tests
        run: |
          cd harold-action/tests
          npm run test:unit

      - name: Upload coverage to Codecov
        if: matrix.node-version == 18
        uses: codecov/codecov-action@v3
        with:
          file: harold-action/tests/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Integration —Ç–µ—Å—Ç—ã
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: lint

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'harold-action/tests/package-lock.json'

      - name: Install dependencies
        run: |
          cd harold-action/tests
          npm ci

      - name: Run integration tests
        run: |
          cd harold-action/tests
          npm run test:integration

  # –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  cross-platform-tests:
    name: Cross-Platform Tests
    needs: [unit-tests, integration-tests]

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18, 20]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'harold-action/tests/package-lock.json'

      - name: Install dependencies
        run: |
          cd harold-action/tests
          npm ci

      - name: Run cross-platform tests
        run: |
          cd harold-action/tests
          npm run test:unit

      - name: Test action scripts (Unix)
        if: runner.os != 'Windows'
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ
          find harold-action/scripts -name "*.sh" -type f -exec test -x {} \;

          # –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
          harold-action/scripts/cache-manager.sh help
          harold-action/scripts/early-exit-check.sh || true

      - name: Test action scripts (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          # –ù–∞ Windows —Ç–µ—Å—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ bash
          bash harold-action/scripts/cache-manager.sh help
          bash harold-action/scripts/early-exit-check.sh || true

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'harold-action/tests/package-lock.json'

      - name: Install dependencies
        run: |
          cd harold-action/tests
          npm ci

      - name: Run npm audit
        run: |
          cd harold-action/tests
          npm audit --audit-level moderate

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.github/mlc_config.json'

      - name: Validate action.yml
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å action.yml
          python -c "
          import yaml
          import sys
          try:
              with open('harold-action/action.yml', 'r') as f:
                  yaml.safe_load(f)
              print('‚úÖ action.yml is valid')
          except yaml.YAMLError as e:
              print(f'‚ùå action.yml is invalid: {e}')
              sys.exit(1)
          "

      - name: Check documentation completeness
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –≤—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
          cd harold-action

          # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ action.yml
          grep -A 1 "description:" action.yml | grep -v "description:" | wc -l > /tmp/params_count

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω–∏ —É–ø–æ–º—è–Ω—É—Ç—ã –≤ README
          params_in_readme=$(grep -c "inputs\." README.md || echo "0")

          echo "Parameters in action.yml: $(cat /tmp/params_count)"
          echo "Parameters documented in README: $params_in_readme"

  # E2E —Ç–µ—Å—Ç—ã (–∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ main –≤–µ—Ç–∫–µ)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Test Harold Action (Basic)
        uses: ./harold-action
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "console.log(\"test\");" > test.js'
          build-path: '.'
        continue-on-error: true

      - name: Verify E2E test results
        run: |
          echo "‚úÖ E2E test completed"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω—ã
          if [ -f "harold-output.txt" ]; then
            echo "‚úÖ Harold output file created"
            cat harold-output.txt
          fi

          if [ -f "harold-exit-code.txt" ]; then
            echo "‚úÖ Harold exit code file created"
            cat harold-exit-code.txt
          fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create large test project
        run: |
          mkdir -p large-test-project/dist

          # –°–æ–∑–¥–∞–µ–º –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
          for i in {1..100}; do
            echo "console.log('Component $i');" > large-test-project/dist/component-$i.js
          done

          # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Harold
          cat > large-test-project/.haroldrc.js << 'EOF'
          export default {
            build: { command: 'echo "Build completed"', path: 'dist' },
            categories: { js: '**/*.js' }
          };
          EOF

      - name: Benchmark Harold Action
        run: |
          start_time=$(date +%s)

          # –ó–∞–ø—É—Å–∫–∞–µ–º Harold Action
          timeout 300 harold-action/scripts/build-and-snapshot-cached.sh base || true

          end_time=$(date +%s)
          duration=$((end_time - start_time))

          echo "Performance test completed in ${duration}s"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–∑—É–º–Ω–æ–µ (< 60s –¥–ª—è 100 —Ñ–∞–π–ª–æ–≤)
          if [ $duration -gt 60 ]; then
            echo "‚ö†Ô∏è Performance test took longer than expected: ${duration}s"
          else
            echo "‚úÖ Performance test completed within acceptable time: ${duration}s"
          fi

  # –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, cross-platform-tests, security-scan, docs-check]
    if: always()

    steps:
      - name: Generate test summary
        run: |
          echo "# CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–≥–æ job'–∞
          if [ "${{ needs.lint.result }}" = "success" ]; then
            echo "‚úÖ **Lint:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Lint:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.unit-tests.result }}" = "success" ]; then
            echo "‚úÖ **Unit Tests:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Unit Tests:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "‚úÖ **Integration Tests:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Integration Tests:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.cross-platform-tests.result }}" = "success" ]; then
            echo "‚úÖ **Cross-Platform Tests:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Cross-Platform Tests:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.security-scan.result }}" = "success" ]; then
            echo "‚úÖ **Security Scan:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Security Scan:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.docs-check.result }}" = "success" ]; then
            echo "‚úÖ **Documentation:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Documentation:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
          failed_count=0
          [ "${{ needs.lint.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.unit-tests.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.integration-tests.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.cross-platform-tests.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.security-scan.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.docs-check.result }}" != "success" ] && ((failed_count++))

          if [ $failed_count -eq 0 ]; then
            echo "## üéâ Overall Status: ALL TESTS PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Overall Status: $failed_count TEST(S) FAILED" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set final status
        run: |
          failed_count=0
          [ "${{ needs.lint.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.unit-tests.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.integration-tests.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.cross-platform-tests.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.security-scan.result }}" != "success" ] && ((failed_count++))
          [ "${{ needs.docs-check.result }}" != "success" ] && ((failed_count++))

          if [ $failed_count -gt 0 ]; then
            echo "‚ùå CI/CD pipeline failed: $failed_count test(s)"
            exit 1
          else
            echo "‚úÖ All CI/CD tests passed"
          fi
