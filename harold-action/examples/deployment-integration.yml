# –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Harold Action —Å –ø—Ä–æ—Ü–µ—Å—Å–æ–º –¥–µ–ø–ª–æ—è
# –ë–ª–æ–∫–∏—Ä—É–µ—Ç –¥–µ–ø–ª–æ–π –ø—Ä–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–º —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –±–∞–Ω–¥–ª–∞

name: Bundle Analysis with Deployment Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  # –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ –±–∞–Ω–¥–ª–∞
  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest

    outputs:
      analysis-passed: ${{ steps.harold.outcome == 'success' }}
      bundle-size-ok: ${{ steps.harold.outcome == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: |
          npm run build:production
          npm run analyze

      - name: Run Harold bundle analysis
        id: harold
        uses: harold-team/harold-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "Build completed"'
          build-path: 'dist'
          config-path: '.haroldrc.production.js'
          comment-title: 'üìä Production Bundle Analysis'
          fail-on-increase: 'true'
          size-threshold: '100000'  # 100KB
          percentage-threshold: '20'  # 20%

      - name: Upload bundle stats
        uses: actions/upload-artifact@v4
        with:
          name: bundle-stats-${{ github.sha }}
          path: |
            dist/
            harold-output.txt
            base-snapshot.json
            pr-snapshot.json

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    needs: bundle-analysis

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download bundle artifacts
        uses: actions/download-artifact@v4
        with:
          name: bundle-stats-${{ github.sha }}

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  # –î–µ–ø–ª–æ–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [bundle-analysis, performance-check]
    if: |
      github.event_name == 'pull_request' &&
      needs.bundle-analysis.outputs.analysis-passed == 'true'

    environment:
      name: staging
      url: https://staging.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download bundle artifacts
        uses: actions/download-artifact@v4
        with:
          name: bundle-stats-${{ github.sha }}

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
          echo "‚úÖ Deployed to staging"

      - name: Update PR with deployment info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ **Staging Deployment Successful**

              Bundle analysis passed all checks and the application has been deployed to staging.

              üìä **Bundle Status**: ‚úÖ Passed
              üåê **Staging URL**: https://staging.example.com
              üì¶ **Artifacts**: Available in workflow run

              The deployment is ready for testing!`
            })

  # –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [bundle-analysis, performance-check]
    if: |
      github.ref == 'refs/heads/main' &&
      needs.bundle-analysis.outputs.bundle-size-ok == 'true'

    environment:
      name: production
      url: https://example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download bundle artifacts
        uses: actions/download-artifact@v4
        with:
          name: bundle-stats-${{ github.sha }}

      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –≤ –ø—Ä–æ–¥–∞–∫—à–Ω
          echo "‚úÖ Deployed to production"

      - name: Notify deployment success
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // –°–æ–∑–¥–∞–µ–º issue –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–µ–ø–ª–æ–µ
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üöÄ Production Deployment - ${context.sha.substring(0, 7)}`,
              body: `Production deployment completed successfully!

              **Commit**: ${context.sha}
              **Bundle Analysis**: ‚úÖ Passed all checks
              **Performance**: ‚úÖ Lighthouse checks passed
              **URL**: https://example.com

              Bundle size is within acceptable limits.`,
              labels: ['deployment', 'production']
            })

  # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–µ–ø–ª–æ—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Ä–∞–∑–º–µ—Ä–æ–º –±–∞–Ω–¥–ª–∞
  deployment-gate:
    name: Deployment Gate
    runs-on: ubuntu-latest
    needs: bundle-analysis
    if: needs.bundle-analysis.outputs.analysis-passed != 'true'

    steps:
      - name: Block deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = `üö´ **Deployment Blocked**

            The bundle size analysis failed, which means the deployment has been automatically blocked.

            **Reasons for blocking:**
            - Bundle size increased beyond acceptable thresholds
            - Performance impact detected

            **Next steps:**
            1. Review the bundle analysis report above
            2. Optimize your code to reduce bundle size
            3. Consider code splitting or lazy loading
            4. Remove unused dependencies

            Once the bundle size is optimized, the deployment will proceed automatically.`;

            if (context.eventName === 'pull_request') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }

            core.setFailed('Deployment blocked due to bundle size increase');
