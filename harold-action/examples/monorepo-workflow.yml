# ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Harold Action Ð² Ð¼Ð¾Ð½Ð¾Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸
# ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾

name: Monorepo Bundle Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð²ÑˆÐ¸ÐµÑÑ Ð¿Ð°ÐºÐµÑ‚Ñ‹
  detect-changes:
    name: Detect Changed Packages
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.changes.outputs.packages }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed packages
        id: changes
        run: |
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð²ÑˆÐ¸Ñ…ÑÑ Ñ„Ð°Ð¹Ð»Ð¾Ð²
          changed_files=$(git diff --name-only HEAD~1 HEAD)

          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð·Ð°Ñ‚Ñ€Ð¾Ð½ÑƒÑ‚Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
          packages=()

          if echo "$changed_files" | grep -q "^packages/frontend/"; then
            packages+=("frontend")
          fi

          if echo "$changed_files" | grep -q "^packages/admin/"; then
            packages+=("admin")
          fi

          if echo "$changed_files" | grep -q "^packages/mobile/"; then
            packages+=("mobile")
          fi

          # ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² JSON Ð¼Ð°ÑÑÐ¸Ð²
          printf -v joined '"%s",' "${packages[@]}"
          packages_json="[${joined%,}]"

          echo "packages=$packages_json" >> $GITHUB_OUTPUT
          echo "Changed packages: $packages_json"

  # ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð°ÐºÐµÑ‚
  analyze-packages:
    name: Analyze Package
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.packages != '[]'

    strategy:
      matrix:
        package: ${{ fromJson(needs.detect-changes.outputs.packages) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd packages/${{ matrix.package }}
          npm ci

      - name: Build package
        run: |
          cd packages/${{ matrix.package }}
          npm run build

      - name: Analyze bundle size for ${{ matrix.package }}
        uses: harold-team/harold-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          build-command: 'echo "Build completed in previous step"'
          build-path: 'dist'
          config-path: '.haroldrc.js'
          comment-title: 'ðŸ“Š Bundle Analysis - ${{ matrix.package }}'
          working-directory: 'packages/${{ matrix.package }}'
          size-threshold: '25000'  # 25KB Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ð°ÐºÐµÑ‚Ð°
          percentage-threshold: '15'  # 15%

  # ÐžÐ±Ñ‰Ð°Ñ ÑÐ²Ð¾Ð´ÐºÐ° Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
  summary:
    name: Analysis Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, analyze-packages]
    if: always()

    steps:
      - name: Create summary comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const packages = ${{ needs.detect-changes.outputs.packages }};
            const analysisResult = '${{ needs.analyze-packages.result }}';

            let body = '## ðŸ“Š Monorepo Bundle Analysis Summary\n\n';

            if (packages.length === 0) {
              body += 'âœ… No packages with bundle changes detected.\n';
            } else {
              body += `Analyzed ${packages.length} package(s): ${packages.join(', ')}\n\n`;

              if (analysisResult === 'success') {
                body += 'âœ… All package analyses completed successfully.\n';
              } else {
                body += 'âš ï¸ Some package analyses encountered issues. Please check individual reports above.\n';
              }

              body += '\n### Package-specific reports:\n';
              packages.forEach(pkg => {
                body += `- ðŸ“¦ **${pkg}**: See detailed analysis above\n`;
              });
            }

            body += '\n---\n*Generated by Harold Action for monorepo*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
